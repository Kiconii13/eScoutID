{% extends 'base.html' %}

{% block title %}
{{ h1 }}
{% endblock %}

{% block style %}
    <link rel="stylesheet" href="{{ url_for('static', filename='addClan-style.css') }}"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='personal.css') }}" />
{% endblock %}

{% block content %}
<div class="icon-wrapper">
    <a href="/dashboard"><img src="/static/logo_green.png" alt="Ikona" class="icon-small" /></a>
</div>

<div class="personal-container">
    <div class="profile-wrapper">
        <h1>{{ h1 }}</h1>
        <div class="profile-picture">
                <img src="" alt="Fotografija" id="output">
            </div>
        <div class="profile-info">
            <form action="#" method="post" class="styled-form" enctype="multipart/form-data">
                <div class="profile-name info">{% if not clan.username == None %}{{ clan.username }}{% endif %}</div>
                <div class="columns">
                    <div class="left-info">
                        <table>
                        <caption>Lične informacije</caption>
                        <tr>
                            <td>Ime:</td>
                            <td>
                                <input class="form-control" type="text" id="first_name" name="first_name" value="{% if not clan.first_name == None %}{{ clan.first_name }}{% endif %}" required>
                            </td>
                        </tr>
                        <tr>
                            <td>Prezime:</td>
                            <td>
                                <input class="form-control" type="text" id="last_name" name="last_name" value="{% if not clan.last_name == None %}{{ clan.last_name }}{% endif %}" required>
                            </td>      
                        </tr>
                        <tr>
                            <td>JMBG:</td>
                            <td>
                                <input class="form-control" type="text" id="jmbg" name="jmbg" value="{% if not clan.jmbg == None %}{{ clan.jmbg }}{% endif %}" required minlength="13" maxlength="13"
                                pattern="^(0[1-9]|[12][0-9]|3[01])(0[1-9]|1[0-2])[0-9]{3}[0-9]{2}[0-9]{3}[0-9]$">
                            </td>
                        </tr>
                        <tr>
                            <td>Broj telefona:</td>
                            <td>
                                <input class="form-control" type="tel" id="phone_number" name="phone_number" value="{% if not clan.phone_number == None %}{{ clan.phone_number }}{% endif %}" pattern="^\+3816[0-9]{6,8}$">
                            </td>
                        </tr>
                        <tr>
                            <td>Adresa:</td>
                            <td>
                                <input class="form-control" type="text" id="address" name="address" value="{% if not clan.address == None %}{{ clan.address }}{% endif %}">
                            </td>
                        </tr>
                        <tr>
                            <td>E-Pošta:</td>
                            <td>
                                <input class="form-control" type="email" id="email" name="email" value="{% if not clan.email == None %}{{ clan.email }}{% endif %}">
                            </td>
                        </tr>
                    </table>
                    </div>
                    <div class="right-info">
                        <table>
                        <caption>Članske informacije</caption>
                            <tr>
                                <td>Broj izviđačke knjžice:</td>
                                <td>
                                    <input class="form-control" type="number" id="scout_id_number" name="scout_id_number" value="{% if not clan.scout_id_number == None %}{{ clan.scout_id_number }}{% endif %}">
                                </td>
                            </tr>
                            <tr>
                                <td>Datum učlanjivanja:</td>
                                <td>
                                    <input class="form-control" type="date" id="join_date" name="join_date" value="{% if not clan.join_date == None %}{{ clan.join_date }}{% endif %}">
                                </td>
                            </tr>
                            <tr>
                                <td>Plaćena članarina:</td>
                                <td>
                                    <input type="checkbox" id="has_paid" name="has_paid" {% if clan.has_paid %} checked {% endif %}>
                                </td>
                            </tr>
                            <tr>
                                <td>Vod:</td>
                                <td>
                                    <select class="form-control" name="vod">
                                    {% for vod in vods %}
                                    <option value="{{ vod.id }}" {% if clan.vod_id == vod.id %} selected {% endif %}>{{ vod.name }}</option>
                                    {% endfor %}
                                    </select>
                                </td>
                            </tr>
                            {% if action != "add" %}
                            <tr>
                                <td>Odred:</td>
                                <td>
                                    <input class="form-control" type="text" id="odred_id" name="odred_id" value="{{ odred }}" disabled>
                                </td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td>Status:</td>
                                <td>
                                    <select id="role" name="role" class="form-control" data-selected="{{ clan.role }}" {% if clan.role in ["admin", "savez_admin"] and current_user.id != clan.id %} readonly {% endif %}>
                                        <option value="clan" {% if clan.role == "clan" %}selected{% endif %}>Član</option>
                                        <option value="admin" {% if clan.role == "admin" %}selected{% endif %}>Administrator</option>
                                        {% if current_user.role == "savez_admin" %}
                                        <option value="savez_admin" {% if clan.role == "savez_admin" %}selected{% endif %}>Administrator saveza</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

            <input type="submit" value="{{h1}}" class="interactive">

            {% if action != "add" and clan.id != current_user.id %}
            <a class="interactive" href="{{ url_for('odred.deleteClan', id=clan.id) }}" onclick="return confirm('Da li ste sigurni da želite da obrišete ovog člana?');">Obriši člana</a>
            {% endif %}

            <a href="javascript:history.back()" class="interactive">Nazad</a>
            </form>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    async function streamToArrayBuffer(stream) {
        const reader = stream.getReader();
        let result = new Uint8Array();
        let done, value;
        while ({ done, value } = await reader.read(), !done) {
            const newResult = new Uint8Array(result.length + value.length);
            newResult.set(result);
            newResult.set(value, result.length);
            result = newResult;
        }
        return result.buffer;
    }

    async function decompressData(arrayBuffer) {
        const stream = new DecompressionStream('gzip');
        const writer = stream.writable.getWriter();
        writer.write(new Uint8Array(arrayBuffer));
        writer.close();

        const decompressedArrayBuffer = await streamToArrayBuffer(stream.readable);
        return decompressedArrayBuffer;
    }

    async function showImage(b64) {
        const compressedFromBase64 = new Uint8Array(atob(b64).split('').map(char => char.charCodeAt(0)));
        const decompressedArrayBuffer = await decompressData(compressedFromBase64);

        const blob = new Blob([decompressedArrayBuffer], { type: 'image' });
        const url = URL.createObjectURL(blob);
        document.getElementById('output').src = url;
    }

    window.onload = async () => {
        fetch(`{{ url_for("odred.getPfp", id = clan.id ) }}`)
            .then(data => data.text())
            .then(text => {
                if (text !== "default") {
                    showImage(text);
                } else {
                    document.getElementById('output').src = "/static/anonymous_pfp.png";
                }
            });
    };

    document.querySelector('.profile-picture').addEventListener('click', function() {
        document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', async function(event) {
        const file = event.target.files[0];
        if (file) {
            // Provera MIME tipa da bi se osiguralo da je fajl slika
            const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            const validFileExtensions = ['jpg', 'jpeg', 'png'];
            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (!validImageTypes.includes(file.type) || !validFileExtensions.includes(fileExtension)) {
                alert("Samo slike u formatima .png i .jpeg su dozvoljene za upload.");
                return;
            }

            // Provera veličine fajla (maksimalno 1 MB)
            const maxSizeInBytes = 1024 * 1024; // 1 MB u bajtovima
            if (file.size > maxSizeInBytes) {
                alert("Slika ne sme biti veća od 1 MB.");
                return;
            }

            const reader = new FileReader();

            reader.onload = async function(e) {
                const arrayBuffer = e.target.result;
                const compressedArrayBuffer = await compressData(arrayBuffer);
                const base64Encoded = btoa(String.fromCharCode(...new Uint8Array(compressedArrayBuffer)));

            }

            reader.readAsArrayBuffer(file);
        }
    });

    async function compressData(arrayBuffer) {
        const stream = new CompressionStream('gzip');
        const writer = stream.writable.getWriter();
        writer.write(new Uint8Array(arrayBuffer));
        writer.close();

        const compressedArrayBuffer = await streamToArrayBuffer(stream.readable);
        return compressedArrayBuffer;
    }
</script>

{% endblock %}