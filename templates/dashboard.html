{% extends "base.html" %}

{% block title %}
Dashboard
{% endblock %}

{% block content %}
<div class="dash">
<div class="img-col">
    <div class="img-container">
        <img src="" alt="Fotografija" id="output">
        <div class="overlay">
            <span class="camera-icon">ğŸ“¸</span>
        </div>
    </div>
    <h2 class="ime-prezime">
        {{ current_user.first_name }} {{ current_user.last_name }}
    </h2>
</div>
    <input type="file" id="fileInput" style="display: none;">
    <div class="data-col">
        <div class="columns">
            <div class="left-col">
                <table>
                    <caption>
                        LiÄne informacije
                    </caption>
                    <tr>
                        <td>Datum roÄ‘enja:</td>
                        <td>{{ current_user.dob.day }}.{{ current_user.dob.month }}.{{ current_user.dob.year }}.</td>
                    </tr>
                    <tr>
                        <td>Broj telefona:</td>
                        <td>
                            <a href="tel:+{{ current_user.phone_number }}">
                                +{{ current_user.phone_number }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td>E-PoÅ¡ta:</td>
                        <td>
                            <a href="mailto:{{ current_user.email }}">
                                {{ current_user.email }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td>Adresa stanovanja:</td>
                        <td>{{ current_user.address }}</td>
                    </tr>
                </table>
            </div>
            <div class="right-col">
                <table>
                    <caption>
                        Odredske informacije
                    </caption>
                    <tr>
                        <td>Datum uÄlanjenja:</td>
                        <td>{{ current_user.join_date.day }}.{{ current_user.join_date.month }}.{{ current_user.join_date.year }}.</td>
                    </tr>
                    <tr>
                        <td>Vod:</td>
                        <td>{{ current_user.vod }}</td>
                    </tr>
                    <tr>
                        <td>ZaduÅ¾enje:</td>
                        <td>{{ current_user.role }}</td>
                    </tr>
                    <tr>
                        <td>PlaÄ‡ena Älanarina:</td>
                        <td>
                            {% if current_user.has_paid %}
                            <span class="good">
                                DA
                            </span>
                            {% else %}
                            <span class="bad">
                                NE
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="button-row">
            <a href="{{ url_for('program.program') }}">
                <input type="button" value="Program" class="btn" />
            </a>
            <a href="{{ url_for('aktivnosti.aktivnosti') }}">
                <input type="button" value="Moje aktivnosti" class="btn" />
            </a>
            <a href="{{ url_for('dashboard.changePassword') }}">
                <input type="button" value="Promena lozinke" class="btn" />
            </a>
            <a href="{{ url_for('dashboard.changeUsername') }}">
                <input type="button" value="Promena korisniÄkog imena" class="btn" />
            </a>
            {% if current_user.role != 'clan' %}
            <a href="{{ url_for('aktivnosti.addAktivnost') }}">
                <input type="button" value="Upravljaj aktivnostima" class="btn" />
            </a>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    async function streamToArrayBuffer(stream) {
        const reader = stream.getReader();
        let result = new Uint8Array();
        let done, value;
        while ({ done, value } = await reader.read(), !done) {
            const newResult = new Uint8Array(result.length + value.length);
            newResult.set(result);
            newResult.set(value, result.length);
            result = newResult;
        }
        return result.buffer;
    }

    async function decompressData(arrayBuffer) {
        const stream = new DecompressionStream('gzip');
        const writer = stream.writable.getWriter();
        writer.write(new Uint8Array(arrayBuffer));
        writer.close();

        const decompressedArrayBuffer = await streamToArrayBuffer(stream.readable);
        return decompressedArrayBuffer;
    }

    async function showImage(b64) {
        const compressedFromBase64 = new Uint8Array(atob(b64).split('').map(char => char.charCodeAt(0)));
        const decompressedArrayBuffer = await decompressData(compressedFromBase64);

        const blob = new Blob([decompressedArrayBuffer], { type: 'image' });
        const url = URL.createObjectURL(blob);
        document.getElementById('output').src = url;
    }

    window.onload = async () => {
        fetch(`{{ url_for("odred.getPfp", id = current_user.id ) }}`)
            .then(data => data.text())
            .then(text => {
                if (text !== "default") {
                    showImage(text);
                }
                else {
                    document.getElementById('output').src = "/static/default_pfp.png";
                }
            });
    };

    document.querySelector('.img-col').addEventListener('click', function() {
        document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', async function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();

            reader.onload = async function(e) {
                const arrayBuffer = e.target.result;
                const compressedArrayBuffer = await compressData(arrayBuffer);
                const base64Encoded = btoa(String.fromCharCode(...new Uint8Array(compressedArrayBuffer)));

                // Slanje podataka serveru
                fetch('{{ url_for("odred.updatePfp", id=current_user.id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image: base64Encoded })
                }).then(response => {
                    if (response.ok) {
                        location.reload(); // OsveÅ¾avanje stranice nakon uspeÅ¡nog upload-a
                    }
                });
            }

            reader.readAsArrayBuffer(file);
        }
    });

    async function compressData(arrayBuffer) {
        const stream = new CompressionStream('gzip');
        const writer = stream.writable.getWriter();
        writer.write(new Uint8Array(arrayBuffer));
        writer.close();

        const compressedArrayBuffer = await streamToArrayBuffer(stream.readable);
        return compressedArrayBuffer;
    }
</script>
{% endblock %}